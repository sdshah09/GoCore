{{- /*
  Renders Kubernetes Service resources for microservices from .Values.services.
  Ports are declared here: grpc + health from .ports, or single port from .service (graphql).
*/ -}}
{{- range $selector, $svc := .Values.services }}
{{- if $svc.enabled }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $svc.name }}
  namespace: {{ $.Release.Namespace | default "default" }}
spec:
  selector:
    app: {{ $selector }}
  ports:
{{- if $svc.service }}
  - port: {{ $svc.service.port }}
    targetPort: {{ $svc.service.targetPort }}
{{- else }}
  - name: grpc
    port: {{ $svc.ports.grpc }}
    targetPort: {{ $svc.ports.grpc }}
  - name: health
    port: {{ $svc.ports.health }}
    targetPort: {{ $svc.ports.health }}
{{- end }}
{{- end }}
{{- end }}
